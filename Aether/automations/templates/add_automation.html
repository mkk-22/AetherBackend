<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Automation</title>
    <style>
        .device-item {
            margin-bottom: 10px;
        }
        .added-device {
            margin-bottom: 10px;
        }
        .form-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Add Automation</h1>
    <form method="POST" onsubmit="return validateForm()">
        {% csrf_token %}
        
        <div class="form-row">
            <label for="name">Automation Name:</label>
            <input type="text" id="name" name="name" required>

            <label for="trigger_time">Trigger Time:</label>
            <input type="time" id="trigger_time" name="trigger_time" required>
        </div>

        <div class="form-row">
            <!-- Room Dropdown -->
            <select id="room" onchange="updateDevices()" >
                <option value="">Select a room</option>
                {% for room in rooms %}
                    <option value="{{ room.room_id }}">{{ room.name }}</option>
                {% endfor %}
            </select>

            <!-- Device Dropdown -->
            <select id="device" disabled >
                <option value="{{ device.device_id }}">Select a device</option>
            </select>

            <!-- On/Off Button -->
            <button type="button" id="status-toggle" disabled onclick="toggleDeviceStatus()">On/Off</button>

            <!-- Add Device Button -->
            <button type="button" id="add-device" disabled onclick="addDevice()">+ Add Device</button>
        </div>

        <div id="added-devices"></div>

        <button type="submit">Save Automation</button>
    </form>

    <p><a href="{% url 'automations_list' %}">Back to Automations</a></p>

    <script>
        let deviceStatus = "off";
        let devicesByRoom = JSON.parse('{{ devices_by_room_json|escapejs }}');

        function updateDevices() {
            let roomId = document.getElementById("room").value;
            let deviceSelect = document.getElementById("device");
            let statusButton = document.getElementById("status-toggle");
            let addButton = document.getElementById("add-device");

            deviceSelect.innerHTML = '<option value="device_id">Select a device</option>';
            deviceSelect.disabled = !roomId;
            statusButton.disabled = true;
            addButton.disabled = true;

            if (roomId) {
                let roomDevices = devicesByRoom[roomId] || [];
                roomDevices.forEach(device => {
                    let option = document.createElement("option");
                    option.value = device.device_id;
                    option.text = device.name;
                    deviceSelect.appendChild(option);
                });

                deviceSelect.onchange = function() {
                    statusButton.disabled = !deviceSelect.value;
                    addButton.disabled = !deviceSelect.value;
                };
            }
        }

        function toggleDeviceStatus() {
            let statusButton = document.getElementById("status-toggle");
            deviceStatus = deviceStatus === "off" ? "on" : "off";
            statusButton.textContent = deviceStatus;
            statusButton.style.backgroundColor = deviceStatus === "on" ? "green" : "red";
        }

        let addedDevices = [];
    
        function addDevice() {
            let roomSelect = document.getElementById("room");
            let deviceSelect = document.getElementById("device");
            let statusButton = document.getElementById("status-toggle");
        
            let roomId = roomSelect.value;
            let roomName = roomSelect.options[roomSelect.selectedIndex].text;
            let deviceId = deviceSelect.value;
            let deviceName = deviceSelect.options[deviceSelect.selectedIndex].text;
            let currentStatus = statusButton.textContent.toLowerCase(); // Get current status
        
            if (!roomId || !deviceId) return;
        
            let deviceKey = `${roomId}-${deviceId}`; // Combine room ID and device ID
        
            if (addedDevices.includes(deviceKey)) {
                alert("This device is already added in this room.");
                return;
            }
        
            let div = document.createElement("div");
            div.className = "added-device";
            div.innerHTML = `
                ${deviceName} (${roomName}) | Status: <strong>${currentStatus}</strong>
                <input type="hidden" name="rooms[]" value="${roomId}">
                <input type="hidden" name="devices[]" value="${deviceId}">
                <input type="hidden" name="statuses[]" value="${currentStatus}">
                <button type="button" onclick="removeDevice(this, '${deviceKey}')">Remove</button>
            `;
        
            document.getElementById("added-devices").appendChild(div);
            addedDevices.push(deviceKey); // Store as "roomId-deviceId" to allow same device in different rooms
        
            // Reset dropdowns and buttons
            deviceSelect.value = "";
            statusButton.textContent = "On/Off";
            statusButton.style.backgroundColor = "white";
            statusButton.disabled = true;
            document.getElementById("add-device").disabled = true;
        }
        
        function removeDevice(button, deviceKey) {
            button.parentElement.remove();
            addedDevices = addedDevices.filter(d => d !== deviceKey);
        }
        
        function validateForm() {
            let name = document.getElementById("name").value.trim();
            let triggerTime = document.getElementById("trigger_time").value;
            let devices = document.getElementById("added-devices").children.length;

            if (!name || !triggerTime || devices === 0) {
                alert("Please enter a name, trigger time, and at least one device.");
                return false;
            }
            return true;
        }
    </script>
</body>
</html>
